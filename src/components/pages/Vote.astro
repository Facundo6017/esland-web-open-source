---
import Layout from '@/layouts/Layout.astro'
import SortVoteIcon from '@/components/icons/SortVote.astro'
import CheckPencilIcon from '@/components/icons/CheckPencil.astro'
import PodiumIcon from '@/components/icons/Podium.astro'
import TapButtonIcon from '@/components/icons/TapButton.astro'
import ShareIcon from '@/components/icons/Share.astro'
import ThinkBrainIcon from '@/components/icons/ThinkBrain.astro'
import { VoteSystem } from '@/components/VoteSystem.tsx'
import { getI18N } from '@/i18n'

import Button from '@/components/Button.astro'
import { getSession } from 'auth-astro/server'
const { currentLocale } = Astro
const i18n = getI18N({ currentLocale })

const session = await getSession(Astro.request)

const bkg = session ? 'vote-system-bkg.webp' : 'vota-bkg.webp'
---

<Layout title='Votar' description='Votar'>
  <section
    class='relative min-h-screen w-full max-w-[100vw] bg-cover bg-no-repeat pb-24'
  >
    <img
      class='absolute -z-10 h-full w-full animate-fade object-cover object-center animate-duration-1000 animate-ease-in-out'
      src={`/${bkg}`}
      alt='ESLAND cover'
    />

    {
      !session && (
        <div class='mx-auto flex max-w-7xl flex-col px-6 pt-40'>
          <h1 class='mb-10 max-w-xl text-balance text-left text-3xl font-bold uppercase leading-loose tracking-wider lg:text-5xl'>
            {i18n.VOTE.TITLE}
          </h1>

          <div class='mb-10'>
            <Button id='vote-button' url='#'>
              {i18n.VOTE.CALL_TO_VOTE}
            </Button>
          </div>
          <p
            set:html={i18n.VOTE.INTRO_CONTENT}
            class='mb-10 max-w-3xl text-pretty px-2 text-2xl'
          />

          <ul class='flex flex-col gap-y-10 pl-4 text-2xl font-extralight'>
            <li class='flex items-center gap-x-6'>
              <SortVoteIcon />
              <span set:html={i18n.VOTE.ADVICE_1} />
            </li>

            <li class='flex items-center gap-x-6'>
              <CheckPencilIcon />
              <span set:html={i18n.VOTE.ADVICE_2} />
            </li>

            <li class='flex items-center gap-x-6'>
              <PodiumIcon />
              <span set:html={i18n.VOTE.ADVICE_3} />
            </li>

            <li class='flex items-center gap-x-6'>
              <>
                <TapButtonIcon />
                <span set:html={i18n.VOTE.ADVICE_4} />
              </>
            </li>

            <li class='flex items-center gap-x-6'>
              <>
                <ShareIcon />
                <span set:html={i18n.VOTE.ADVICE_5} />
              </>
            </li>

            <li class='flex items-center gap-x-6'>
              <ThinkBrainIcon />
              <span set:html={i18n.VOTE.ADVICE_6} />
            </li>
            <span class='mt-4 text-base opacity-85'>
              {i18n.VOTE.TIME_LIMIT}
            </span>
          </ul>
        </div>
      )
    }

    {
      session && (
        <div class='relative mx-auto flex max-w-7xl flex-col pt-20'>
          <VoteSystem client:load currentLocale={currentLocale}>
            <div class='flex items-center gap-4'>
              <img
                class='h-12 w-12 rounded-full'
                src={session.user?.image}
                alt=''
              />
              <div class='text-yellow-300'>
                <h4 class='text-xl font-bold'>{session.user?.name}</h4>
                <button
                  id='logout-button'
                  class='flex items-center justify-center gap-x-2 border-b border-transparent text-sm font-light text-white hover:border-white'
                >
                  <span>{i18n.LOG_OUT}</span>
                </button>
              </div>
            </div>
          </VoteSystem>
        </div>
      )
    }
  </section>
</Layout>

<script>
  const { signIn, signOut } = await import('auth-astro/client')
  // pongo un $ delante para que se vea que es un elemento del DOM
  // es una cosa que se hacía en el pasado con jQuery y es una manía
  // que se me ha quedado porque me gusta :)
  const $loginButton = document.querySelector('#vote-button')
  const $logoutButton = document.querySelector('#logout-button')

  $loginButton?.addEventListener('click', async (event) => {
    event.preventDefault()
    await signIn('twitch')
  })

  $logoutButton?.addEventListener('click', async (event) => {
    event.preventDefault()
    await signOut()
  })
</script>

<style>
  p {
    text-shadow:
      0 0 5px rgba(0, 0, 0, 0.3),
      0 0 10px rgba(0, 0, 0, 0.7);
  }
</style>
